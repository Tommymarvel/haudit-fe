'use client';

import Link from 'next/link';
import Image from 'next/image';
import { usePathname } from 'next/navigation';
import {
  Home,
  HelpCircle,
  ChevronDown,
  Bell,
} from 'lucide-react';
import { cn } from '@/lib/cn';
import { useAuth } from '@/contexts/AuthContext';
import { useNotifications } from '@/hooks/useNotifications';

type NavItem = {
  href: string;
  label: string;
  icon: React.ReactNode;
  badge?: boolean;
};

const NAV: NavItem[] = [
  {
    href: '/dashboard',
    label: 'Dashboard',
    icon: <Home className="h-5 w-5" />,
  },
  {
    href: '/advance',
    label: 'Advance-O-Meter',
    icon: (
      <svg
        width="20"
        height="16"
        viewBox="0 0 20 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        className="h-5 w-5"
      >
        <path
          d="M17 0C17.7956 0 18.5587 0.316071 19.1213 0.87868C19.6839 1.44129 20 2.20435 20 3V13C20 13.7956 19.6839 14.5587 19.1213 15.1213C18.5587 15.6839 17.7956 16 17 16H3C2.20435 16 1.44129 15.6839 0.87868 15.1213C0.316071 14.5587 0 13.7956 0 13V3C0 2.20435 0.316071 1.44129 0.87868 0.87868C1.44129 0.316071 2.20435 0 3 0H17ZM18 6H2V13C2.00003 13.2449 2.08996 13.4813 2.25272 13.6644C2.41547 13.8474 2.63975 13.9643 2.883 13.993L3 14H17C17.2449 14 17.4813 13.91 17.6644 13.7473C17.8474 13.5845 17.9643 13.3603 17.993 13.117L18 13V6ZM15 9C15.2549 9.00028 15.5 9.09788 15.6854 9.27285C15.8707 9.44782 15.9822 9.68695 15.9972 9.94139C16.0121 10.1958 15.9293 10.4464 15.7657 10.6418C15.6021 10.8373 15.3701 10.9629 15.117 10.993L15 11H12C11.7451 10.9997 11.5 10.9021 11.3146 10.7272C11.1293 10.5522 11.0178 10.313 11.0028 10.0586C10.9879 9.80416 11.0707 9.55362 11.2343 9.35817C11.3979 9.16271 11.6299 9.0371 11.883 9.007L12 9H15ZM17 2H3C2.73478 2 2.48043 2.10536 2.29289 2.29289C2.10536 2.48043 2 2.73478 2 3V4H18V3C18 2.73478 17.8946 2.48043 17.7071 2.29289C17.5196 2.10536 17.2652 2 17 2Z"
          fill="#5A5A5A"
        />
      </svg>
    ),
  },
  {
    href: '/expenses',
    label: 'Expenses',
    icon: (
      <svg
        width="18"
        height="18"
        viewBox="0 0 18 18"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fillRule="evenodd"
          clip-rule="evenodd"
          d="M0 2.5C0 1.83696 0.263392 1.20107 0.732233 0.732233C1.20107 0.263392 1.83696 0 2.5 0H15C15.7956 0 16.5587 0.316071 17.1213 0.87868C17.6839 1.44129 18 2.20435 18 3V17C18 17.1779 17.9526 17.3526 17.8626 17.5061C17.7726 17.6596 17.6433 17.7863 17.488 17.8731C17.3327 17.96 17.157 18.0038 16.9791 18.0001C16.8012 17.9963 16.6275 17.9452 16.476 17.852L13.75 16.174L11.024 17.852C10.8664 17.9489 10.685 18.0003 10.5 18.0003C10.315 18.0003 10.1336 17.9489 9.976 17.852L7.25 16.174L4.524 17.852C4.37245 17.9452 4.19878 17.9963 4.02088 18.0001C3.84299 18.0038 3.66733 17.96 3.51202 17.8731C3.35672 17.7863 3.22739 17.6596 3.13738 17.5061C3.04737 17.3526 2.99995 17.1779 3 17V11H1C0.734784 11 0.48043 10.8946 0.292893 10.7071C0.105357 10.5196 0 10.2652 0 10V2.5ZM5 15.21L6.726 14.148C6.88359 14.0511 7.06498 13.9997 7.25 13.9997C7.43502 13.9997 7.61641 14.0511 7.774 14.148L10.5 15.826L13.226 14.148C13.3836 14.0511 13.565 13.9997 13.75 13.9997C13.935 13.9997 14.1164 14.0511 14.274 14.148L16 15.21V3C16 2.73478 15.8946 2.48043 15.7071 2.29289C15.5196 2.10536 15.2652 2 15 2H4.95C4.983 2.162 5 2.329 5 2.5V15.21ZM2.5 2C2.36739 2 2.24021 2.05268 2.14645 2.14645C2.05268 2.24021 2 2.36739 2 2.5V9H3V2.5C3 2.36739 2.94732 2.24021 2.85355 2.14645C2.75979 2.05268 2.63261 2 2.5 2ZM7 6C7 5.73478 7.10536 5.48043 7.29289 5.29289C7.48043 5.10536 7.73478 5 8 5H13C13.2652 5 13.5196 5.10536 13.7071 5.29289C13.8946 5.48043 14 5.73478 14 6C14 6.26522 13.8946 6.51957 13.7071 6.70711C13.5196 6.89464 13.2652 7 13 7H8C7.73478 7 7.48043 6.89464 7.29289 6.70711C7.10536 6.51957 7 6.26522 7 6ZM7 10C7 9.73478 7.10536 9.48043 7.29289 9.29289C7.48043 9.10536 7.73478 9 8 9H12C12.2652 9 12.5196 9.10536 12.7071 9.29289C12.8946 9.48043 13 9.73478 13 10C13 10.2652 12.8946 10.5196 12.7071 10.7071C12.5196 10.8946 12.2652 11 12 11H8C7.73478 11 7.48043 10.8946 7.29289 10.7071C7.10536 10.5196 7 10.2652 7 10Z"
          fill="#5A5A5A"
        />
      </svg>
    ),
  },
  {
    href: '/royalty',
    label: 'Royalty',
    icon: (
      <svg
        width="20"
        height="14"
        viewBox="0 0 20 14"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fillRule="evenodd"
          clip-rule="evenodd"
          d="M18 1.00268e-07C18.5046 -0.000159579 18.9906 0.190406 19.3605 0.533497C19.7305 0.876587 19.9572 1.34684 19.995 1.85L20 2V12C20.0002 12.5046 19.8096 12.9906 19.4665 13.3605C19.1234 13.7305 18.6532 13.9572 18.15 13.995L18 14H2C1.49542 14.0002 1.00943 13.8096 0.639452 13.4665C0.269471 13.1234 0.0428434 12.6532 0.00500022 12.15L1.00268e-07 12V2C-0.000159579 1.49542 0.190407 1.00943 0.533497 0.639452C0.876588 0.269471 1.34684 0.0428434 1.85 0.00500021L2 1.00268e-07H18ZM15.003 2H4.997L5 2.125C5 2.50255 4.92564 2.8764 4.78115 3.22521C4.63667 3.57403 4.4249 3.89096 4.15793 4.15793C3.89096 4.4249 3.57403 4.63667 3.22522 4.78115C2.8764 4.92564 2.50255 5 2.125 5L2 4.997V9.003L2.125 9C2.8875 9 3.61877 9.3029 4.15793 9.84207C4.6971 10.3812 5 11.1125 5 11.875L4.997 12H15.003L15 11.875C15 11.1418 15.2802 10.4362 15.7832 9.90274C16.2862 9.36925 16.974 9.0481 17.706 9.005L17.938 9.001L18 9.003V4.997L17.875 5C17.1418 4.99999 16.4362 4.71983 15.9027 4.21682C15.3692 3.71381 15.0481 3.02597 15.005 2.294L15 2.062L15.003 2ZM17.875 11C17.7495 11 17.6255 11.027 17.5114 11.0791C17.3973 11.1313 17.2957 11.2073 17.2136 11.3022C17.1314 11.397 17.0707 11.5084 17.0354 11.6288C17.0001 11.7492 16.9911 11.8758 17.009 12H18V11.009C17.9586 11.0031 17.9168 11.0001 17.875 11ZM2.125 11C2.08317 11.0001 2.0414 11.0031 2 11.009V12H2.991C3.00892 11.8758 2.99993 11.7492 2.96463 11.6288C2.92934 11.5084 2.86856 11.397 2.78642 11.3022C2.70428 11.2073 2.60271 11.1313 2.48859 11.0791C2.37447 11.027 2.25047 11 2.125 11ZM10 3C11.0609 3 12.0783 3.42143 12.8284 4.17157C13.5786 4.92172 14 5.93913 14 7C14 8.06087 13.5786 9.07828 12.8284 9.82843C12.0783 10.5786 11.0609 11 10 11C8.93913 11 7.92172 10.5786 7.17157 9.82843C6.42143 9.07828 6 8.06087 6 7C6 5.93913 6.42143 4.92172 7.17157 4.17157C7.92172 3.42143 8.93913 3 10 3ZM10 5C9.46957 5 8.96086 5.21071 8.58579 5.58579C8.21072 5.96086 8 6.46957 8 7C8 7.53043 8.21072 8.03914 8.58579 8.41421C8.96086 8.78929 9.46957 9 10 9C10.5304 9 11.0391 8.78929 11.4142 8.41421C11.7893 8.03914 12 7.53043 12 7C12 6.46957 11.7893 5.96086 11.4142 5.58579C11.0391 5.21071 10.5304 5 10 5ZM2.991 2H2V2.991C2.12418 3.00892 2.25076 2.99993 2.37117 2.96463C2.49157 2.92934 2.60297 2.86856 2.69781 2.78642C2.79266 2.70428 2.86873 2.60271 2.92087 2.48859C2.97301 2.37447 3 2.25047 3 2.125L2.998 2.062L2.991 2ZM18 2H17.009C16.9911 2.12418 17.0001 2.25076 17.0354 2.37116C17.0707 2.49156 17.1314 2.60297 17.2136 2.69781C17.2957 2.79266 17.3973 2.86873 17.5114 2.92087C17.6255 2.97301 17.7495 3 17.875 3L17.938 2.998L18 2.99V2Z"
          fill="#5A5A5A"
        />
      </svg>
    ),
  },
  {
    href: '/notifications',
    label: 'Notifications',
    icon: <Bell className="h-5 w-5" />,
    badge: true,
  },
];


function SidebarLink({ href, label, icon, badge }: { href: string; label: string; icon: React.ReactNode; badge?: boolean }) {
  const pathname = usePathname();
  const active = pathname?.startsWith(href);
  const { unreadCount } = useNotifications();

  return (
    <Link
      href={href}
      className={cn(
        'group relative mb-1 flex items-center gap-3  px-3 py-2 text-sm text-[#5A5A5A] hover:bg-[#DFDFDF]',
        active && 'bg-[#DFDFDF] text-neutral-900'
      )}
    >
      <span
        className={cn('text-[#5A5A5A]', active && 'text-[#7B00D4]')}
      >
        {icon}
      </span>
      <span className="truncate text-[#5A5A5A] text-base ">
        {label}
      </span>
      {badge && unreadCount > 0 && (
        <span className="flex h-5 w-5 items-center justify-center self-end rounded-full bg-red-500 text-[10px] font-semibold text-white">
          {unreadCount > 9 ? '9+' : unreadCount}
        </span>
      )}
      {/* Purple active strip */}
      <span
        className={cn(
          'absolute right-0 top-0 h-full w-[3px] rounded-r-sm bg-[#7B00D4] transition-opacity',
          active ? 'opacity-100' : 'opacity-0 group-hover:opacity-50'
        )}
      />
    </Link>
  );
}

export default function Sidebar() {
  const { user, logout } = useAuth();
  return (
    <div className="flex h-dvh w-full overflow-hidden flex-col border-r border-neutral-200 bg-neutral-50/70 backdrop-blur-sm">
      {/* Header */}
      <div className="px-4 pt-4 pb-3">
        <div className="flex items-end gap-2">
          <div className=" rounded-l grid place-items-center">
            <Image src="/haudit-logo.svg" alt="Haudit" width={32} height={32} />
          </div>
          <span className="text-2xl flex self-end font-bold text-[#3C3C3C]">
            Haudit
          </span>
        </div>

        {/* Period selector */}
        <button
          type="button"
          className="mt-3 w-full inline-flex items-center justify-between rounded-xl border border-neutral-200 bg-white px-3 py-3 text-sm text-[#5A5A5A] hover:bg-neutral-50"
        >
          Haudit Jan 2025 to July 2025
          <ChevronDown className="h-4 w-4 text-neutral-500" />
        </button>
      </div>

      {/* Nav */}
      <nav className="mt-3 flex-1 overflow-y-auto ">
        {NAV.map((item) => (
          <SidebarLink key={item.href} {...item} />
        ))}
      </nav>

      {/* Bottom actions */}
      <div className="mt-auto px-2 pb-3">
        <SidebarLink
          href="/faq"
          label="FAQ"
          icon={<HelpCircle className="h-6 w-6 text-neutral-500" />}
        />
        <SidebarLink
          href="/settings"
          label="Settings"
          icon={
            <svg
              width="18"
              height="18"
              viewBox="0 0 18 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M13 12C14.306 12 15.418 12.835 15.83 14H17C17.2652 14 17.5196 14.1054 17.7071 14.2929C17.8946 14.4804 18 14.7348 18 15C18 15.2652 17.8946 15.5196 17.7071 15.7071C17.5196 15.8946 17.2652 16 17 16H15.83C15.6234 16.5855 15.2403 17.0926 14.7334 17.4512C14.2265 17.8099 13.6209 18.0025 13 18.0025C12.3791 18.0025 11.7735 17.8099 11.2666 17.4512C10.7597 17.0926 10.3766 16.5855 10.17 16H1C0.734784 16 0.48043 15.8946 0.292893 15.7071C0.105357 15.5196 0 15.2652 0 15C0 14.7348 0.105357 14.4804 0.292893 14.2929C0.48043 14.1054 0.734784 14 1 14H10.17C10.377 13.4149 10.7603 12.9084 11.2671 12.5502C11.774 12.1921 12.3794 11.9998 13 12ZM13 14C12.7348 14 12.4804 14.1054 12.2929 14.2929C12.1054 14.4804 12 14.7348 12 15C12 15.2652 12.1054 15.5196 12.2929 15.7071C12.4804 15.8946 12.7348 16 13 16C13.2652 16 13.5196 15.8946 13.7071 15.7071C13.8946 15.5196 14 15.2652 14 15C14 14.7348 13.8946 14.4804 13.7071 14.2929C13.5196 14.1054 13.2652 14 13 14ZM5 6C5.58899 5.99992 6.16497 6.17322 6.65613 6.49829C7.14729 6.82336 7.5319 7.28582 7.762 7.828L7.829 8H17C17.2549 8.00028 17.5 8.09788 17.6854 8.27285C17.8707 8.44782 17.9822 8.68695 17.9972 8.94139C18.0121 9.19584 17.9293 9.44638 17.7657 9.64183C17.6021 9.83729 17.3701 9.9629 17.117 9.993L17 10H7.83C7.6284 10.5703 7.25917 11.0663 6.77073 11.4231C6.28229 11.7799 5.69744 11.9808 5.09285 11.9994C4.48827 12.018 3.89217 11.8534 3.38273 11.5273C2.87328 11.2012 2.47427 10.7288 2.238 10.172L2.17 10H1C0.74512 9.99972 0.499968 9.90212 0.314632 9.72715C0.129296 9.55218 0.017765 9.31305 0.00282788 9.05861C-0.0121092 8.80416 0.0706746 8.55362 0.234265 8.35817C0.397855 8.16271 0.629904 8.0371 0.883 8.007L1 8H2.17C2.37701 7.41493 2.76032 6.90842 3.26715 6.55024C3.77397 6.19206 4.37938 5.99982 5 6ZM5 8C4.73478 8 4.48043 8.10536 4.29289 8.29289C4.10536 8.48043 4 8.73478 4 9C4 9.26522 4.10536 9.51957 4.29289 9.70711C4.48043 9.89464 4.73478 10 5 10C5.26522 10 5.51957 9.89464 5.70711 9.70711C5.89464 9.51957 6 9.26522 6 9C6 8.73478 5.89464 8.48043 5.70711 8.29289C5.51957 8.10536 5.26522 8 5 8ZM13 1.24966e-07C14.306 1.24966e-07 15.418 0.835 15.83 2H17C17.2652 2 17.5196 2.10536 17.7071 2.29289C17.8946 2.48043 18 2.73478 18 3C18 3.26522 17.8946 3.51957 17.7071 3.70711C17.5196 3.89464 17.2652 4 17 4H15.83C15.6234 4.58553 15.2403 5.09257 14.7334 5.45121C14.2265 5.80985 13.6209 6.00245 13 6.00245C12.3791 6.00245 11.7735 5.80985 11.2666 5.45121C10.7597 5.09257 10.3766 4.58553 10.17 4H1C0.734784 4 0.48043 3.89464 0.292893 3.70711C0.105357 3.51957 0 3.26522 0 3C0 2.73478 0.105357 2.48043 0.292893 2.29289C0.48043 2.10536 0.734784 2 1 2H10.17C10.377 1.41493 10.7603 0.908421 11.2671 0.55024C11.774 0.192059 12.3794 -0.000178928 13 1.24966e-07ZM13 2C12.7348 2 12.4804 2.10536 12.2929 2.29289C12.1054 2.48043 12 2.73478 12 3C12 3.26522 12.1054 3.51957 12.2929 3.70711C12.4804 3.89464 12.7348 4 13 4C13.2652 4 13.5196 3.89464 13.7071 3.70711C13.8946 3.51957 14 3.26522 14 3C14 2.73478 13.8946 2.48043 13.7071 2.29289C13.5196 2.10536 13.2652 2 13 2Z"
                fill="#5A5A5A"
              />
            </svg>
          }
        />

        {/* Divider */}
        <div className="my-3 h-px w-full bg-neutral-200" />

        {/* User card */}
        <div className="flex items-center justify-between rounded-xl px-3 py-2">
          <div className="flex items-center gap-3">
            {user?.avatar ? (
              // eslint-disable-next-line @next/next/no-img-element
              <img
                src={user.avatar}
                alt="User"
                className="h-7 w-7 rounded-full object-cover"
              />
            ) : (
              <Image
                src="/svgs/user.svg"
                alt="User"
                width={28}
                height={28}
                className="h-7 w-7 rounded-full object-cover"
              />
            )}
            <div className="min-w-0">
              <p className="truncate text-sm font-semibold text-[#3C3C3C]">
                {user ? `${user.first_name} ${user.last_name}` : 'Loading...'}
              </p>
              <p className="truncate text-sm text-[#777777]">
                {user?.email}
              </p>
            </div>
          </div>
          <button onClick={logout} className="hover:opacity-75" title="Logout">
            <svg
              width="36"
              height="36"
              viewBox="0 0 36 36"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M15.5 25.5H12.1667C11.7246 25.5 11.3007 25.3244 10.9882 25.0118C10.6756 24.6993 10.5 24.2754 10.5 23.8333V12.1667C10.5 11.7246 10.6756 11.3007 10.9882 10.9882C11.3007 10.6756 11.7246 10.5 12.1667 10.5H15.5M21.3333 22.1667L25.5 18M25.5 18L21.3333 13.8333M25.5 18H15.5"
                stroke="#AAAAAA"
                strokeWidth="1.67"
                strokeLinecap="round"
                strokeLinejoin="round"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>
  );
}
